name: record

on:
  workflow_dispatch:
  schedule:
   - cron: "30 4 * * *"
   
permissions:
  contents: read
  actions: write
  id-token: write

concurrency:
  group: record
  cancel-in-progress: false

jobs:
  record:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Show time
        run: date -u && date

      - name: Checkout repo
        uses: actions/checkout@v4

      # âœ… æ”¹ç”¨å®˜æ–¹ Tailscale Actionï¼ˆOAuthï¼‰ï¼Œä¸è¦å†ä¼  hostname
      - name: Tailscale (OAuth)
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          # è¿™äº› tag å¿…é¡»åœ¨ä½ çš„ Tailscale ACL ä¸­è¢«å…è®¸
          tags: tag:github-actions,tag:recorder
          # å¯é€‰ï¼šå›ºå®šç‰ˆæœ¬æˆ–ä½¿ç”¨ latest
          # version: latest

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg inotify-tools curl jq netcat-openbsd

      - name: Verify ffmpeg RTSP support
        run: |
          echo "Checking ffmpeg version and protocols:"
          ffmpeg -version
          echo "Supported protocols:"
          ffmpeg -protocols 2>/dev/null | grep rtsp || echo "RTSP not found in protocols"

      - name: Setup TeraBox credentials
        run: |
          echo "TeraBox configuration loaded from secrets"
          echo "MUNFAQQIHA method credentials:"
          echo "  TERABOX_JSTOKEN is set: ${{ secrets.TERABOX_JSTOKEN != '' }}"
          echo "  TERABOX_BDSTOKEN is set: ${{ secrets.TERABOX_BDSTOKEN != '' }} (optional but recommended)"
          echo "  TERABOX_COOKIE is set: ${{ secrets.TERABOX_COOKIE != '' }}"
          echo "Notification configuration:"
          echo "  DINGDING_WEBHOOK is set: ${{ secrets.DINGDING_WEBHOOK != '' }}"

      - name: Run recorder
        env:
          RTSP_URL: ${{ secrets.RTSP_URL }}
          TERABOX_JSTOKEN: ${{ secrets.TERABOX_JSTOKEN }}
          TERABOX_BDSTOKEN: ${{ secrets.TERABOX_BDSTOKEN }}
          TERABOX_COOKIE: ${{ secrets.TERABOX_COOKIE }}
          TERABOX_REMOTE_FOLDER: ${{ vars.TERABOX_REMOTE_FOLDER || '/rtsp-videos' }}
          DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
        run: |
          chmod +x ./record.sh ./terabox_upload_simple.sh
          ./record.sh

      # ğŸ” å¤±è´¥æ—¶æŠŠ tailscaled æ—¥å¿—æ‰“å‡ºæ¥ï¼Œå¿«é€Ÿå®šä½ï¼ˆéå¸¸æœ‰ç”¨ï¼‰
      - name: Dump tailscaled log on failure
        if: failure()
        run: |
          if [ -f "$HOME/tailscaled.log" ]; then
            echo "=== tailscaled.log ==="
            cat "$HOME/tailscaled.log"
          else
            echo "tailscaled.log not found"
          fi

  auto-restart:
    needs: record
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      # âš ï¸ ä½ åŸæ¥è¿™é‡Œå¼•ç”¨äº† steps.gate.outputs.runï¼Œä½†æ²¡æœ‰åä¸º gate çš„æ­¥éª¤ï¼Œä¼šæ°¸è¿œè·³è¿‡
      # å¦‚æœä½ å°±æ˜¯æƒ³æ€»æ˜¯è‡ªè§¦å‘ä¸€æ¬¡ï¼ˆä¸å»ºè®®ï¼‰ï¼Œå»æ‰ if æ¡ä»¶ï¼›å¦åˆ™è¯·çœŸæ­£åŠ ä¸Š gate æ­¥éª¤ã€‚
      - name: Trigger self
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: record.yml
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
